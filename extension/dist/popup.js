let endpoints=[],targets=[],activeTargetIndex=0,targetMode="active";function updateLists(){updateEndpointList(),updateTargetList()}function updateTargetList(){const e=document.getElementById("targetList");e.innerHTML="",chrome.runtime.sendMessage({action:"getStats"},(({stats:t})=>{targets.forEach(((a,n)=>{const s=document.createElement("li");s.classList.add("slide-in"),a.protected&&s.classList.add("protected-target");Object.values(t||{}).reduce(((e,t)=>e+(t.targets[a.url]||0)),0);s.innerHTML=`\n        <div class="target-info">\n          <span class="target-url">${a.url}</span>\n          ${a.pattern?'<span class="target-pattern" title="Pattern"><i data-feather="filter"></i></span>':""}\n          ${a.protected?'<span class="protected-badge" title="Protected Target"><i data-feather="lock"></i></span>':""}\n          ${n===activeTargetIndex?'<span class="active-badge" title="Active Target"><i data-feather="check-circle"></i></span>':""}\n        </div>\n        <div class="target-actions">\n          <button class="set-active" title="Set Active" data-index="${n}"><i data-feather="check"></i></button>\n          ${a.protected?"":`<button class="remove-target" title="Remove" data-index="${n}"><i data-feather="trash-2"></i></button>`}\n        </div>\n      `,e.appendChild(s)})),feather.replace()}));const t=document.getElementById("currentTarget");if(t){const e=targets[activeTargetIndex];t.innerHTML=`\n      <span class="info-label">Current Target:</span>\n      <span class="info-value">${e?e.url:"Not set"}</span>\n    `}}function timeAgo(e){const t=Math.floor((new Date-e)/1e3),a={year:31536e3,month:2592e3,week:604800,day:86400,hour:3600,minute:60,second:1};for(const[e,n]of Object.entries(a)){const a=Math.floor(t/n);if(a>=1)return`${a} ${e}${1===a?"":"s"} ago`}return"just now"}function addTarget(){const e=document.getElementById("targetUrl"),t=document.getElementById("targetPattern"),a=document.getElementById("targetMode"),n=e.value.trim(),s=t.value.trim(),r=a.value;if(!n)return e.classList.add("error"),void setTimeout((()=>e.classList.remove("error")),1e3);if(targets.some((e=>e.url.toLowerCase()===n.toLowerCase())))return e.classList.add("warning"),setTimeout((()=>e.classList.remove("warning")),1e3),void toast("URL already exists in targets");try{new URL(n),targets.push({url:n,pattern:s,mode:r,protected:!1}),1!==targets.length&&"active"!==r||(activeTargetIndex=targets.length-1),chrome.storage.local.set({targets:targets,activeTargetIndex:activeTargetIndex,targetMode:r},(()=>{e.value="",t.value="",e.classList.add("success"),setTimeout((()=>e.classList.remove("success")),1e3),updateTargetList()}))}catch(t){e.classList.add("error"),setTimeout((()=>e.classList.remove("error")),1e3)}}function isValidUrl(e){try{if(e.includes("*")){const t=e.replace(/\./g,"\\.").replace(/\*/g,".*");return new RegExp(`^${t}$`).test("test.example.com")}return new URL(e),!0}catch(e){return!1}}function updateEndpointList(){const e=document.getElementById("endpointList");e.innerHTML="",endpoints.forEach(((t,a)=>{const n=document.createElement("li");n.classList.add("slide-in"),n.innerHTML=`\n      <div class="endpoint-info">\n        <span class="endpoint-url">${t}</span>\n      </div>\n      <div class="endpoint-actions">\n        <button class="remove-endpoint" title="Remove" data-index="${a}">\n          <i data-feather="trash-2"></i>\n        </button>\n      </div>\n    `,e.appendChild(n)})),feather.replace()}function addEndpoint(){const e=document.getElementById("endpoint"),t=(document.getElementById("add"),e.value.trim());return t&&isValidUrl(t)?endpoints.includes(t)?(e.classList.add("warning"),void setTimeout((()=>e.classList.remove("warning")),1e3)):(endpoints.push(t),void chrome.runtime.sendMessage({action:"updateEndpoints",endpoints:endpoints},(()=>{e.value="",e.classList.add("success"),setTimeout((()=>e.classList.remove("success")),1e3),updateEndpointList()}))):(e.classList.add("error"),void setTimeout((()=>e.classList.remove("error")),1e3))}function removeEndpoint(e){endpoints.splice(e,1),chrome.storage.local.set({enabledEndpoints:endpoints},(()=>{chrome.runtime.sendMessage({action:"updateEndpoints",endpoints:endpoints},(()=>{updateEndpointList()}))}))}function updateInterceptorUI(e){const t=document.getElementById("statusIndicator");t&&(t.className="status-indicator "+(e?"active":"inactive"),t.title="Interceptor "+(e?"Enabled":"Disabled"))}function toast(e){const t=document.createElement("div");t.className="warning-toast",t.textContent=e,document.body.appendChild(t),setTimeout((()=>{t.classList.add("fade-out"),setTimeout((()=>t.remove()),300)}),3e3)}document.getElementById("saveTarget").addEventListener("click",addTarget),document.getElementById("targetUrl").addEventListener("keypress",(e=>{"Enter"===e.key&&addTarget()})),document.getElementById("targetList").addEventListener("click",(e=>{if(e.target.classList.contains("set-active")){const t=parseInt(e.target.dataset.index);isNaN(t)||(activeTargetIndex=t,targetMode="active",chrome.storage.local.set({activeTargetIndex:activeTargetIndex,targetMode:targetMode},updateTargetList))}else if(e.target.classList.contains("remove-target")){const t=parseInt(e.target.dataset.index);isNaN(t)||targets[t].protected||(targets.splice(t,1),activeTargetIndex>=t&&(activeTargetIndex=Math.max(0,activeTargetIndex-1)),chrome.storage.local.set({targets:targets,activeTargetIndex:activeTargetIndex},updateTargetList))}})),chrome.storage.local.get(["enabledEndpoints","targets","activeTargetIndex","targetMode"],(e=>{e.enabledEndpoints&&(endpoints=e.enabledEndpoints);const t={url:"https://quefork.somrit.in",pattern:"",mode:"active",protected:!0};if(e.targets){const a=e.targets.filter((e=>e.url!==t.url));targets=[t,...a]}else targets=[t];"number"==typeof e.activeTargetIndex&&(activeTargetIndex=e.activeTargetIndex),e.targetMode&&(targetMode=e.targetMode),updateLists()})),document.getElementById("targetUrl").addEventListener("input",(e=>{const t=document.getElementById("saveTarget"),a=e.target.value.trim();try{new URL(a),t.disabled=!1,e.target.classList.remove("error")}catch(n){t.disabled=!0,a&&!e.target.classList.contains("error")&&e.target.classList.add("error")}})),document.getElementById("endpoint").addEventListener("input",(e=>{const t=document.getElementById("add"),a=e.target.value.trim();isValidUrl(a)?(t.disabled=!1,e.target.classList.remove("error")):(t.disabled=!0,a&&!e.target.classList.contains("error")&&e.target.classList.add("error"))})),document.getElementById("endpointList").addEventListener("click",(e=>{const t=e.target.closest(".remove-endpoint");if(t){const e=parseInt(t.dataset.index);isNaN(e)||removeEndpoint(e)}})),document.getElementById("add").addEventListener("click",addEndpoint),document.getElementById("endpoint").addEventListener("keypress",(e=>{"Enter"===e.key&&addEndpoint()})),chrome.storage.local.get(["enabledEndpoints"],(e=>{e.enabledEndpoints&&(endpoints=e.enabledEndpoints,updateEndpointList())})),document.addEventListener("DOMContentLoaded",(()=>{const e=setInterval((()=>{window.feather&&(clearInterval(e),feather.replace())}),50);setTimeout((()=>clearInterval(e)),2e3)})),chrome.storage.local.get(["interceptorEnabled"],(e=>{updateInterceptorUI(e.interceptorEnabled??!0)})),chrome.runtime.onMessage.addListener((e=>{"interceptorStateChanged"===e.action&&updateInterceptorUI(e.enabled)}));